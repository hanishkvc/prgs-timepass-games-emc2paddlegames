<html>
	<head>
		<title> E=MC^2 of Paddle Games </title>
		<style>
			#help { font-size: small; }
			#canvas { touch-action: manipulation; }
		</style>
	</head>
	<body>
		<div id="top">
		<h2> E=MC^2 of Paddle Games </h2>
		<withloveto> Thanks for all the pizzas!!! Shreya, Kunju, Nanda, Chinnu </withloveto>
		</div>
		<hr>
		<div id="main">
			<canvas id="canvas" width=640 height=240> What Canvas??? No no no noo noo noooooo </canvas>
		</div>
		<hr>
		<div id="controls">
			<p id="score"> </p>
			<p id="status"> Save Nature Save Earth </p>
		</div>
		<hr>
		<div id="help">
			<p> Get a point each time the ball hits the paddle. And definitely dont drop the ball.
			<p> Get ever increasing points for getting into next levels.
			<p> Bounce the ball straight multiple times to switch levels.
			<p> Look out for the short lived special zones.
			<p> Ball can warp around on screen, but paddle cant.
			<p> Left and right arrow keys could help control the paddle better.
		</div>
	<script>
		var gTimer;
		var gElScore;
		var gElStatus;
		var gElCanvas;
		var gCtxt;
		var ball = {
			'x': 0, 'y': 0,
			'w': 20, 'h': 20,
			'dX': 0, 'dY': 2,
			'xAdj': 10
			}
		var paddle = {
			'x': 0, 'y': 0,
			'w': 40, 'h': 5,
			'minD': 4,
			'xAdj': 20
			}
		var gArcRad = 10;
		const LAZY_REPEAT = 2;
		var gRepeat = LAZY_REPEAT;
		var gLevel = 1;
		var POINTS_NORMAL = 1;
		var POINTS_NEXTLEVEL = 4;
		var gPoints = 0;
		var gZone = {
			'type': -1, 't2l': 0,
			'x1': 0, 'x2': 0,
			'w': 0,
			};
		var ZONE_TIME2LIVE = 1024;
		var gDispMid;
		var gStartTime;


		function user_time() {
			var delta = new Date((new Date()) - gStartTime);
			return `${delta.getUTCMinutes()}.${delta.getUTCSeconds()}`
		}


		function update_status(msg) {
			var gameTime = user_time();
			if (gZone.type === -1)
				gElScore.textContent = `L${gLevel} : T${gameTime} : P${gPoints}`;
			else
				gElScore.textContent = `L${gLevel} : T${gameTime} : P${gPoints} : T2L ${gZone.t2l}`;
			gElStatus.textContent = msg;
		}


		function display_zones() {
			if (gZone.type > 0) {
				gZone.t2l -= 1;
				if (gZone.t2l < 0) {
					gZone.type = -1;
					return;
				}
				gCtxt.fillStyle = "#208020";
				gCtxt.fillRect(gZone.x1, 0, gZone.w, gElCanvas.height);
			}
		}


		function display_me() {
			gCtxt.fillStyle = "#20D0D0";
			gCtxt.fillRect(0, 0, gElCanvas.width, gElCanvas.height);
			display_zones();
			if (gRepeat === 0)
				gCtxt.fillStyle = "#D0D020";
			else
				gCtxt.fillStyle = "#802020";
			gCtxt.fillRect(ball.x-ball.xAdj, ball.y, ball.w, ball.h);
			gCtxt.fillStyle = "#202020";
			gCtxt.fillRect(paddle.x-paddle.xAdj, paddle.y, paddle.w, paddle.h);
		}


		function arc_out() {
			gCtxt.beginPath()
			gCtxt.arc(ball.x,ball.y,gArcRad,0,3.14,true);
			gArcRad += 5;
			gCtxt.fillStyle=`rgb( ${Math.random()*256}, ${Math.random()*256}, ${Math.random()*256})`;
			gCtxt.fill()
			if (gArcRad > 100) clearInterval(gTimer);
		}


		function next_level() {
			ball.dX = 0.5 - Math.random();
			gPoints += POINTS_NEXTLEVEL;
			POINTS_NEXTLEVEL *= 2;
			POINTS_NORMAL += 1;
			gLevel += 1;
			update_status("NextLevel, Run kid run...");
			ball.dY *= 1.3;
			gRepeat = LAZY_REPEAT;
			if (Math.random() > 0.5) {
				gZone.type = Math.random()*gElCanvas.width;
				gZone.x1 = gZone.type - (gZone.w/2);
				gZone.x2 = gZone.type + (gZone.w/2);
				gZone.t2l = ZONE_TIME2LIVE;
			} else {
				gZone.type = -1;
			}
		}


		function next_frame() {
			ball.y += ball.dY;
			ball.x += ball.dX;
			if ((paddle.y - ball.y) < paddle.h) {
				//update_status("INFO: Ball reached bottom");
				bD = ball.x - paddle.x;
				if (Math.abs(bD) > paddle.xAdj) {
					update_status(`Oops:Dropped the ball ${Math.round(bD)}, refresh to start over`);
					clearInterval(gTimer);
					gTimer = setInterval(arc_out, 100);
				} else {
					gPoints += POINTS_NORMAL;
					update_status(`INFO:Byalalu, contact established with ball ${Math.round(bD)}`);
					ball.dY = -1*ball.dY;
					bD = Math.round(bD/8)
					if (bD === 0) {
						ball.dX = 0;
						gRepeat -= 1;
						if (gRepeat == 0) {
							update_status("ALERT: Meteriot on the way...");
						}
						if (gRepeat < 0) {
							next_level();
						}
					} else {
						gRepeat = LAZY_REPEAT;
						if (bD > 0) {
							ball.dX = 0.4;
						} else {
							ball.dX = -0.4;
						}
					}
				}
			}
			if ((ball.y < 0) && (ball.dY < 0)) {
				//update_status("INFO: Ball reached top");
				ball.dY = -1*ball.dY;
			}
			if ((ball.x < 0) || (ball.x > gElCanvas.width)) {
				/*
				update_status("Yeh Kya uha..., refresh to start over");
				clearInterval(gTimer);
				*/
				if (ball.x < 0) ball.x = gElCanvas.width;
				if (ball.x > gElCanvas.width) ball.x = 0;
			}
			if (gZone.type >= 0) {
				if ((gZone.x1 < ball.x) && (ball.x < gZone.x2)) {
					gPoints += POINTS_NORMAL;
					update_status("INFO: lucky you");
				}
			}
			display_me();
		}


		function move_paddle(loc, force) {
			var delta = Math.abs((paddle.x - ball.x)/2);
			if (delta < paddle.minD) delta = paddle.minD;
			if (loc < gDispMid){
				paddle.x -= delta;
				if (paddle.x <= 0) paddle.x = 0;
			} else {
				paddle.x += delta;
				if (paddle.x >= gElCanvas.width) paddle.x = gElCanvas.width;
			}
		}


		function handle_key(ev) {
			if (ev.key === "ArrowLeft") {
				move_paddle(0);
			} else if (ev.key === "ArrowRight") {
				move_paddle(gElCanvas.width);
			}
		}


		function handle_click(ev) {
			//console.log(ev);
			move_paddle(ev.offsetX);
			ev.preventDefault();
		}


		function blackhole_dblclick(ev) {
			ev.preventDefault();
		}


		function ball_init() {
			ball.x = Math.random()*gElCanvas.width;
			ball.y = 0;
			ball.xAdj = Math.round(ball.w/2)
		}


		function paddle_init() {
			paddle.x = Math.random()*gElCanvas.width;
			paddle.y = gElCanvas.height-10;
			paddle.xAdj = Math.round(paddle.w/2)
		}


		function init_me() {
			gElStatus = document.getElementById("status");
			gElScore = document.getElementById("score");
			gElCanvas = document.getElementById("canvas");
			gElCanvas.width = window.innerWidth*0.97;
			gElCanvas.height = window.innerHeight*0.5;
			gCtxt = gElCanvas.getContext("2d");
			ball_init();
			paddle_init();
			ZONE_TIME2LIVE = Math.round(ZONE_TIME2LIVE*(gElCanvas.width/720))
			gZone.w = gElCanvas.width/10;
			gStartTime = new Date();
			gTimer = setInterval(next_frame, 50);
			window.onkeydown = handle_key;
			gDispMid = gElCanvas.width/2;
			gElCanvas.onclick = handle_click;
			gElCanvas.ondblclick = blackhole_dblclick;
		}


		document.addEventListener("DOMContentLoaded", (ev) => {
			init_me();
		});
	</script>

	</body>
</html>
