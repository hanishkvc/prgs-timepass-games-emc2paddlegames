<html>
	<head>
		<title> E=MC^2 of Paddle Games </title>
		<style>
			#help { font-size: small; }
		</style>
	</head>
	<body>
		<div id="top">
		<h2> E=MC^2 of Paddle Games </h2>
		<withloveto> Thanks for all the pizzas!!! Shreya, Kunju, Nanda, Chinnu </withloveto>
		</div>
		<hr>
		<div id="main">
			<canvas id="canvas" width=640 height=240> What Canvas??? No no no noo noo noooooo </canvas>
		</div>
		<hr>
		<div id="controls">
			<p id="score"> </p>
			<p id="status"> Save Nature Save Earth </p>
		</div>
		<hr>
		<div id="help">
			<p> Get a point each time the ball hits the paddle. And definitely dont drop the ball.
			<p> Get ever increasing points for getting into next levels.
			<p> Bounce the ball straight multiple times to switch levels.
			<p> Look out for the short lived special zones.
			<p> Use left and right arrow keys to control the paddle.
		</div>
	<script>
		var gTimer;
		var gScore;
		var gStatus;
		var gCanvas;
		var gCtxt;
		var bX, bY;
		const bW = 20;
		const bH = 20;
		var bXD = 0, bYD = 2;
		const bXAdj = Math.round(bW/2, 0);
		var pX, bY;
		const pW = 40, pH = 5, pD = 10;
		const pXAdj = Math.round(pW/2, 0);
		var gArcRad = 10;
		const LAZY_REPEAT = 2;
		var gRepeat = LAZY_REPEAT;
		var gLevel = 1;
		const POINTS_NORMAL = 1;
		var POINTS_NEXTLEVEL = 4;
		var gPoints = 0;
		var gSpecialZone = -1;
		var gZoneX1, gZoneX2, gZoneWidth;
		const ZONE_TIME2LIVE = 1024;
		var gZoneTime2Live;
		var gDispMid;


		function update_status(msg) {
			if (gSpecialZone === -1)
				gScore.textContent = `L${gLevel} : P${gPoints}`;
			else
				gScore.textContent = `L${gLevel} : P${gPoints} : T2L ${gZoneTime2Live}`;
			gStatus.textContent = msg;
		}


		function display_zones() {
			if (gSpecialZone > 0) {
				gZoneTime2Live -= 1;
				if (gZoneTime2Live < 0) {
					gSpecialZone = -1;
					return;
				}
				gCtxt.fillStyle = "#208020";
				gCtxt.fillRect(gZoneX1, 0, gZoneWidth, gCanvas.height);
			}
		}


		function display_me() {
			gCtxt.fillStyle = "#20D0D0";
			gCtxt.fillRect(0, 0, gCanvas.width, gCanvas.height);
			display_zones();
			if (gRepeat === 0)
				gCtxt.fillStyle = "#D0D020";
			else
				gCtxt.fillStyle = "#802020";
			gCtxt.fillRect(bX-bXAdj, bY, bW, bH);
			gCtxt.fillStyle = "#202020";
			gCtxt.fillRect(pX-pXAdj, pY, pW, pH);
		}


		function arc_out() {
			gCtxt.beginPath()
			gCtxt.arc(bX,bY,gArcRad,0,3.14,true);
			gArcRad += 5;
			gCtxt.fillStyle=`rgb( ${Math.random()*256}, ${Math.random()*256}, ${Math.random()*256})`;
			gCtxt.fill()
			if (gArcRad > 100) clearInterval(gTimer);
		}


		function next_level() {
			bXD = 0.5 - Math.random();
			gPoints += POINTS_NEXTLEVEL;
			POINTS_NEXTLEVEL *= 2;
			gLevel += 1;
			update_status("NextLevel, Run kid run...");
			bYD *= 1.3;
			gRepeat = LAZY_REPEAT;
			if (Math.random() > 0.5) {
				gSpecialZone = Math.random()*gCanvas.width;
				gZoneX1 = gSpecialZone - (gZoneWidth/2);
				gZoneX2 = gSpecialZone + (gZoneWidth/2);
				gZoneTime2Live = ZONE_TIME2LIVE;
			} else {
				gSpecialZone = -1;
			}
		}


		function next_frame() {
			bY += bYD;
			bX += bXD;
			if ((pY - bY) < pH) {
				//update_status("INFO: Ball reached bottom");
				bD = bX - pX;
				if (Math.abs(bD) > pXAdj) {
					update_status(`Oops:Dropped the ball ${bD}, refresh to start over`);
					clearInterval(gTimer);
					gTimer = setInterval(arc_out, 100);
				} else {
					gPoints += POINTS_NORMAL;
					update_status(`INFO:Byalalu, contact established with ball ${bD}`);
					bYD = -1*bYD;
					bD = Math.round(bD/8)
					if (bD === 0) {
						bXD = 0;
						gRepeat -= 1;
						if (gRepeat == 0) {
							update_status("ALERT: Meteriot on the way...");
						}
						if (gRepeat < 0) {
							next_level();
						}
					} else {
						gRepeat = LAZY_REPEAT;
						if (bD > 0) {
							bXD = 0.4;
						} else {
							bXD = -0.4;
						}
					}
				}
			}
			if ((bY < 0) && (bYD < 0)) {
				//update_status("INFO: Ball reached top");
				bYD = -1*bYD;
			}
			if ((bX < 0) || (bX > gCanvas.width)) {
				update_status("Yeh Kya uha..., refresh to start over");
				clearInterval(gTimer);
			}
			if (gSpecialZone >= 0) {
				if ((gZoneX1 < bX) && (bX < gZoneX2)) {
					gPoints += POINTS_NORMAL;
					update_status("INFO: lucky you");
				}
			}
			display_me();
		}


		function move_paddle(loc, force) {
			delta = (pX - bX)/2;
			if (delta < pD) delta = pD;
			if (loc < gDispMid){
				pX -= delta;
				if (pX <= 0) pX = 0;
			} else {
				pX += delta;
				if (pX >= gCanvas.width) pX = gCanvas.width;
			}
		}


		function handle_key(ev) {
			if (ev.key === "ArrowLeft") {
				move_paddle(0);
			} else if (ev.key === "ArrowRight") {
				move_paddle(gCanvas.width);
			}
		}


		function handle_click(ev) {
			//console.log(ev);
			move_paddle(ev.offsetX);
			ev.preventDefault();
		}


		function init_me() {
			gStatus = document.getElementById("status");
			gScore = document.getElementById("score");
			gCanvas = document.getElementById("canvas");
			gCtxt = gCanvas.getContext("2d");
			bX = Math.random()*gCanvas.width;
			bY = 0;
			pX = Math.random()*gCanvas.width;
			pY = gCanvas.height-10;
			gZoneWidth = gCanvas.width/10;
			gTimer = setInterval(next_frame, 50);
			window.onkeydown = handle_key;
			gDispMid = gCanvas.width/2;
			gCanvas.onclick = handle_click;
		}


		document.addEventListener("DOMContentLoaded", (ev) => {
			init_me();
		});
	</script>

	</body>
</html>
